<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>2048</title>
    <style>
    header {
        width: 100%;
        margin: 30px auto;
        text-align: center;
    }
    button{
        width:30%;
        background-color: #FA795F;
        border-radius: 5px;
        border-style: none;
    }
    #box {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
    }
    #canvas {
        width: 98%;
        margin: 1% auto;
        border: 3px solid #FA795F;
        border-radius: 5px;
        height: 400px;
    }
    .cell {
        width: 23%;
        margin: 1%;
        height: 23%;
        float: left;
        position: relative;
        background-color: #EED0C8;
    }
    p {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -120%);
    }
    </style>
</head>
<body>
    <div id="box">
        <header>
            <button id="button">2048</button>
        </header>
        <div id="canvas">
        </div>
    </div>
    <script>

    //问题：没有gameover判断，没动画   
    var arr = [];
    var color = {
        2: "#FFC3A0",
        4: "#DCA889",
        8: "#BD9176",
        16: "#9B7760",
        32: "#7F624F",
        64: "#7F333C",
        128: "#A03F4B",
        256: "#B14653",
        512: "#C64E5D",
        1024: "#D75465",
        2048: "#E65869",
        4096: "#FF6175",
        8192: "#FF292D",
    }

    ready()
    init(arr);

    function ready() {
        var container = new DocumentFragment();
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
                let cell = document.createElement('div');
                cell.className = "cell";
                cell.id = "cell-" + i + '-' + j;
                cell.innerHTML = "<p></p>";
                container.appendChild(cell)
            }
        }
        document.getElementById('canvas').appendChild(container);
        document.getElementById("button").onclick = init;

        document.onkeydown = (event) => {
            switch (event.keyCode) {
                case 13:
                    init(arr);
                    break;
                case 37:
                    move(arr, 'left');
                    break;
                case 38:
                    move(arr, 'top');
                    break;
                case 39:
                    move(arr, 'right');
                    break;
                case 40:
                    move(arr, 'bottom');
                    break;
            }
        };
    }

    function init(arr) {
        for (let i = 0; i < 4; i++) {
            arr[i] = [0, 0, 0, 0]
        }
        render(arr)
    }

    function render(arr) {
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
                let val = (arr[i][j] ? arr[i][j] : '');
                let cell = document.getElementById('cell-' + i + '-' + j);
                cell.children[0].innerText = val;
                if (val) {
                    cell.style.backgroundColor = color[val];
                } else {
                    cell.style.backgroundColor = "#EED0C8";
                }
            }
        }
    }

    function genera(arr) {
        let nullArr = [];
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
                !arr[i][j] && nullArr.push([i, j])
            }
        }
        let index = Math.floor(Math.random() * nullArr.length);
        let x = nullArr[index][0];
        let y = nullArr[index][1];
        arr[x][y] = (Math.random() > 0.5 ? 2 : 4);
        render(arr);
    }

    function moveLeft(arr) {
        for (let i = 0; i < 4; i++) {
            var flag = true;
            for (let j = 1; j < 4; j++) {
                if (arr[i][j]) {
                    for (let k = 1; k <= j; k++) {

                        if (!arr[i][j - k]) {
                            arr[i][j - k] = arr[i][j + 1 - k];
                            arr[i][j + 1 - k] = 0;
                        }
                        if (arr[i][j - k] === arr[i][j + 1 - k] && flag) {
                            arr[i][j - k] = arr[i][j + 1 - k] * 2;
                            arr[i][j + 1 - k] = 0;
                            //合并数字只进行一次
                            flag = false;
                        }
                    }
                }
            }
        }
    }

    function move(arr, dir) {
        //将不是向左移动的矩阵全部转为左矩阵，更新后转回原矩阵然后渲染
        var n = []
        if (dir == 'top') {
            for (var i = 0; i < 4; i++) {
                n[i] = [];
                for (var j = 0; j < 4; j++) {
                    n[i][j] = arr[j][3 - i]
                }
            }
            moveLeft(n);
            for (var i = 0; i < 4; i++) {
                arr[i] = [];
                for (var j = 0; j < 4; j++) {
                    arr[i][j] = n[3 - j][i]
                }
            }
        }
        if (dir == 'bottom') {
            for (var i = 0; i < 4; i++) {
                n[i] = [];
                for (var j = 0; j < 4; j++) {
                    n[i][j] = arr[3 - j][i]
                }
            }
            moveLeft(n);
            for (var i = 0; i < 4; i++) {
                arr[i] = [];
                for (var j = 0; j < 4; j++) {
                    arr[i][j] = n[j][3 - i]
                }
            }
        }
        if (dir == 'left') {
            moveLeft(arr);
        }
        if (dir == 'right') {
            for (var i = 0; i < 4; i++) {
                n[i] = [];
                for (var j = 0; j < 4; j++) {
                    n[i][j] = arr[i][3 - j]
                }
            }
            moveLeft(n);
            for (var i = 0; i < 4; i++) {
                arr[i] = [];
                for (var j = 0; j < 4; j++) {
                    arr[i][j] = n[i][3 - j]
                }
            }
        }
        render(arr)
        genera(arr);
    }
    </script>
</body>

</html>
